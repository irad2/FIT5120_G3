<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Basic Meta Tags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!-- Site Metas -->
    <title>Map Of Accident And Risk</title>
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Site Icons -->
    <link rel="icon" href="images/fevicon.png" type="image/gif" />

    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD86HVoelH6hAMHnX5HuyTKoX2O_EoPgGo&callback=initMap&libraries=geometry,drawing,places"
            async defer></script>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <!-- Main Stylesheet -->
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <!-- Responsive CSS -->
    <link rel="stylesheet" href="css/responsive.css">

    <!-- Custom CSS for Map Integration -->
    <style>
        #map {
            height: 500px;  /* Adjusted height for the map container */
            width: 100%;
        }
        .map-form {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 1000;
            width: 300px; /* Adjust width as necessary */
        }
        .map-form input, .map-form button {
            width: 100%;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="header_section header_bg">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a href="index.html" class="logo"><img src="images/logo1.png"></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="accidentmap.html">Accident and risk map</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="routmap.html">Cycling Route</a>
                    </li>
                </ul>
            </div>
        </nav>
        <div id="main_slider" class="carousel slide" data-ride="carousel">
            <div class="container">
                <div class="row">
                    <div class="col-md-7">
                        <div class="image_1"><img src="images/img-1.png"></div>
                    </div>
                    <div class="col-md-5">
                        <h1 class="banner_taital">Melbourne Cycling</h1>
                        <p class="banner_text">Safe Road. Safe Ride.</p>
                        <div class="contact_bt"><a href="https://bicyclenetwork.com.au/tips-resources/?gad_source=1" target="_blank">Explore Now</a></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Section Start -->
    <div class="map_section layout_padding">
        <h1 class="map_taital">Map Of Cycling Road</h1>
        <div id="map"></div>  <!-- Google Map Container -->
        <div class="map-form">
            <input type="text" id="startingInput" placeholder="Enter start location">
            <input type="text" id="destinationInput" placeholder="Enter destination">
            <button onclick="calculateAndDisplayRoute()">Search</button>
            <button onclick="clearSearch()">Clear</button>
        </div>
    </div>

    <!-- Custom JavaScript for Google Maps -->
    <script>
        var map, directionsService, directionsRenderer, autocompleteStart, autocompleteEnd, unsafeZones = [];
        
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: -37.8136, lng: 144.9631},
                zoom: 10
            });
        
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);
        
            autocompleteStart = new google.maps.places.Autocomplete(document.getElementById('startingInput'));
            autocompleteEnd = new google.maps.places.Autocomplete(document.getElementById('destinationInput'));
        
            fetchUnsafeZones().then(data => {
                displayUnsafeZones(data);
            });
        }
        
        async function fetchUnsafeZones() {
            try {
                const response = await fetch('/most_dangerous.json');
                return await response.json();
            } catch (error) {
                console.error('Failed to fetch unsafe zones:', error);
                return [];
            }
        }
        
        function displayUnsafeZones(data) {
            data.forEach(zone => {
                var zonePosition = {lat: zone.Latitude, lng: zone.Longitude};
                var marker = new google.maps.Marker({
                    position: zonePosition,
                    map: map,
                    title: "Unsafe Zone: " + zone.Road
                });
        
                var circle = new google.maps.Circle({
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#FF0000',
                    fillOpacity: 0.35,
                    map: map,
                    center: zonePosition,
                    radius: 500  // radius should be adjusted based on your specific needs
                });
        
                // Store the circle object for later use in routing checks
                unsafeZones.push(circle);
            });
        }
        
        function calculateAndDisplayRoute() {
            var start = autocompleteStart.getPlace();
            var end = autocompleteEnd.getPlace();
        
            if (!start || !end) {
                alert('Please select both a start and end location.');
                return;
            }
        
            directionsService.route({
                origin: {lat: start.geometry.location.lat(), lng: start.geometry.location.lng()},
                destination: {lat: end.geometry.location.lat(), lng: end.geometry.location.lng()},
                travelMode: 'BICYCLING'
            }, function(response, status) {
                if (status === 'OK') {
                    var routePath = response.routes[0].overview_path;
                    if (!checkRouteSafety(routePath)) {
                        directionsRenderer.setDirections(response);
                    } else {
                        alert('No safe route available that avoids all unsafe zones.');
                    }
                } else {
                    console.error('Directions request failed due to ' + status);
                }
            });
        }
        
        function checkRouteSafety(routePath) {
            return routePath.some(pathPoint => {
                return unsafeZones.some(zone => {
                    return google.maps.geometry.spherical.computeDistanceBetween(pathPoint, zone.getCenter()) < zone.getRadius();
                });
            });
        }
        
        function clearSearch() {
            document.getElementById('startingInput').value = '';
            document.getElementById('destinationInput').value = '';
            directionsRenderer.set('directions', null);
        }
        </script>
        
    <!-- Bootstrap and Other Libraries -->
    <script src="js/jquery.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery-3.0.0.min.js"></script>
    <script src="js/plugin.js"></script>
    <!-- Sidebar -->
    <script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
    <script src="js/custom.js"></script>
    <!-- Owl Carousel -->
    <script src="js/owl.carousel.js"></script>
</body>
</html>
